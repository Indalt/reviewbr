
const fs = require('fs');
const path = require('path');

const OUTPUT_FILE = 'projects/data_mining/downloads/stage_1_results.json';

// Inputs
const files = [
    'projects/data_mining/downloads/stage_1_ne.json',
    'projects/data_mining/downloads/stage_1_alice.json',
    'projects/data_mining/downloads/stage_1_bvs.json' // Generated by convert_ris_json.js
];

let allResults = [];
let stats = {
    total: 0,
    sources: {}
};

function cleanAndParse(filePath) {
    if (!fs.existsSync(filePath)) {
        console.log(`Skipping ${filePath} (Not found)`);
        return [];
    }

    const raw = fs.readFileSync(filePath, 'utf8');
    // Extract JSON between markers if present
    let jsonStr = raw;
    if (raw.includes("__JSON_START__")) {
        const parts = raw.split("__JSON_START__");
        if (parts.length > 1) {
            const endParts = parts[1].split("__JSON_END__");
            jsonStr = endParts[0];
        }
    }

    try {
        const data = JSON.parse(jsonStr);
        // Handle if it's the CLI output structure { stats, results } or raw array
        if (data.results && Array.isArray(data.results)) {
            return data.results;
        } else if (Array.isArray(data)) {
            return data;
        }
        return [];
    } catch (e) {
        console.error(`Error parsing ${filePath}: ${e.message}`);
        return [];
    }
}

for (const file of files) {
    const results = cleanAndParse(file);
    console.log(`Loaded ${results.length} records from ${file}`);
    allResults = allResults.concat(results);
}

// Add stats
stats.total = allResults.length;
allResults.forEach(r => {
    const src = r._origin || r.source || 'Unknown';
    stats.sources[src] = (stats.sources[src] || 0) + 1;
});

// Wrap in standard format
const finalOutput = {
    timestamp: new Date().toISOString(),
    stats: stats,
    results: allResults
};

fs.writeFileSync(OUTPUT_FILE, JSON.stringify(finalOutput, null, 2));
console.log(`Merged ${allResults.length} records to ${OUTPUT_FILE}`);
console.log("Source Breakdown:", stats.sources);
